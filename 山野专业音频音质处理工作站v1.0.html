<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>山野专业音频音质处理工作站</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body {
            background: linear-gradient(135deg, #0a0a1a 0%, #151530 100%);
            color: #e0e0ff; min-height: 100vh; padding: 20px; line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 40px; padding-top: 20px; }
        h1 {
            font-size: 2.8rem; margin-bottom: 10px;
            background: linear-gradient(90deg, #4CAF50, #2196F3, #9C27B0);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .subtitle { 
            font-size: 1.1rem; color: #a0b0ff; margin-bottom: 30px; 
            max-width: 800px; margin-left: auto; margin-right: auto;
            padding: 15px; background: rgba(30, 35, 55, 0.3); border-radius: 10px;
            border-left: 4px solid #4CAF50;
        }
        .main-content { display: flex; flex-wrap: wrap; gap: 30px; margin-bottom: 40px; }
        .panel {
            background: rgba(25, 30, 50, 0.85); border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.08);
            flex: 1; min-width: 300px; backdrop-filter: blur(10px);
        }
        .panel-wide { flex-basis: 100%; }
        .section-title {
            font-size: 1.5rem; margin-bottom: 20px; color: #4CAF50;
            display: flex; align-items: center; gap: 10px; 
            padding-bottom: 8px; border-bottom: 2px solid rgba(76, 175, 80, 0.3);
        }
        .section-title i { font-size: 1.3rem; }
        .file-upload-area {
            border: 3px dashed #3a4a7a; border-radius: 15px; padding: 40px 20px; text-align: center; cursor: pointer;
            transition: all 0.3s; margin-bottom: 25px; background: rgba(0, 0, 0, 0.2);
        }
        .file-upload-area:hover { border-color: #4CAF50; background: rgba(76, 175, 80, 0.05); }
        .file-upload-area i { font-size: 3rem; color: #3a4a7a; margin-bottom: 15px; transition: color 0.3s; }
        .file-upload-area:hover i { color: #4CAF50; }
        .file-input { display: none; }
        .file-info { margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; font-size: 0.95rem; }
        .file-info div { margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .file-info i { color: #2196F3; }
        .control-group { margin-bottom: 25px; }
        .slider-container { margin-bottom: 22px; }
        .slider-label {
            display: flex; justify-content: space-between; margin-bottom: 8px;
            font-weight: 600; color: #b0c4ff;
        }
        .slider-value {
            font-weight: bold; color: #4CAF50; background: rgba(76, 175, 80, 0.1); 
            padding: 2px 10px; border-radius: 10px; min-width: 60px; text-align: center;
        }
        .slider {
            width: 100%; height: 10px; -webkit-appearance: none; appearance: none;
            background: linear-gradient(90deg, #1a3a1a, #4CAF50); border-radius: 5px; outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 22px; height: 22px; border-radius: 50%;
            background: #ffffff; cursor: pointer; border: 3px solid #4CAF50; box-shadow: 0 0 10px #4CAF50;
        }
        .eq-bands {
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: space-between; margin-top: 10px;
        }
        .eq-band { flex: 1; min-width: 70px; }
        .eq-band .slider { background: linear-gradient(90deg, #2a1a4a, #9C27B0); }
        .eq-band .slider::-webkit-slider-thumb { border-color: #9C27B0; box-shadow: 0 0 10px #9C27B0; }
        .eq-band label { display: block; text-align: center; font-size: 0.9rem; color: #c0a0ff; margin-top: 5px; }
        .button-group {
            display: flex; gap: 15px; flex-wrap: wrap; margin-top: 30px;
        }
        .btn {
            padding: 14px 24px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: all 0.3s; flex: 1; min-width: 170px;
        }
        .btn-primary {
            background: linear-gradient(90deg, #2196F3, #1976D2); color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #1976D2, #1565C0); transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.08); color: white; border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15); transform: translateY(-3px);
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .visualizer-container {
            width: 100%; height: 250px; background: rgba(0, 0, 0, 0.3); border-radius: 12px; overflow: hidden;
            margin-bottom: 20px; position: relative;
        }
        #waveformCanvas, #spectrumCanvas { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        #spectrumCanvas { opacity: 0.7; }
        .meter-container {
            display: flex; align-items: center; gap: 20px; margin-top: 20px;
            background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 12px;
        }
        .vu-meter {
            flex: 1; height: 20px; background: linear-gradient(90deg, #00aa00, #ffff00, #ff0000);
            border-radius: 10px; overflow: hidden; position: relative;
        }
        .vu-level {
            height: 100%; background: rgba(255, 255, 255, 0.5); width: 0%; transition: width 50ms;
        }
        .status {
            padding: 12px; border-radius: 10px; margin-top: 20px; text-align: center; font-weight: 600;
            display: none; background: rgba(76, 175, 80, 0.1); color: #4CAF50; border: 1px solid rgba(76, 175, 80, 0.3);
        }
        .status.error { background: rgba(244, 67, 54, 0.1); color: #F44336; border-color: rgba(244, 67, 54, 0.3); }
        .status.processing { 
            background: rgba(33, 150, 243, 0.1); color: #2196F3; border-color: rgba(33, 150, 243, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .status.processing i { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .preset-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        .preset-btn {
            padding: 8px 15px; background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3);
            color: #4CAF50; border-radius: 8px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.3s; flex: 1; min-width: 120px;
        }
        .preset-btn:hover { background: rgba(76, 175, 80, 0.2); transform: translateY(-2px); }
        .processing-progress {
            height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; margin-top: 15px; overflow: hidden;
        }
        .processing-progress-bar {
            height: 100%; background: linear-gradient(90deg, #2196F3, #4CAF50); width: 0%; transition: width 0.3s;
        }
        footer {
            text-align: center; margin-top: 40px; padding: 20px; color: #8090cc; font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        @media (max-width: 768px) {
            .main-content { flex-direction: column; }
            h1 { font-size: 2.2rem; }
            .btn { min-width: 100%; }
            .eq-bands { gap: 10px; }
            .eq-band { min-width: 60px; }
            .preset-btn { min-width: 100px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-mountain"></i> 山野专业音频音质处理工作站</h1>
            <p class="subtitle">
                上传您的音频文件，使用专业级母带处理技术提升音质。本工具提供多段均衡、动态压缩、谐波饱和与立体声增强功能，
                所有处理均在浏览器本地完成，100%保护您的音频隐私。
            </p>
        </header>

        <div class="main-content">
            <!-- 文件上传面板 -->
            <section class="panel">
                <h2 class="section-title"><i class="fas fa-file-upload"></i> 音频上传</h2>
                <div class="file-upload-area" id="dropArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>拖放或点击选择音频文件</p>
                    <p style="font-size: 0.9rem; margin-top: 10px; color: #a0b0ff;">支持 MP3, WAV, OGG, M4A 格式</p>
                    <input type="file" id="fileInput" class="file-input" accept="audio/*">
                </div>
                <div class="file-info" id="fileInfo">
                    <div><i class="fas fa-info-circle"></i> 未选择文件</div>
                    <div id="fileName"></div>
                    <div id="fileSize"></div>
                    <div id="fileDuration"></div>
                </div>
                <div class="processing-progress" id="processingProgress" style="display: none;">
                    <div class="processing-progress-bar" id="processingProgressBar"></div>
                </div>
                <div class="status" id="statusMessage"></div>
            </section>

            <!-- 均衡器面板 -->
            <section class="panel">
                <h2 class="section-title"><i class="fas fa-wave-square"></i> 10段参数均衡器</h2>
                <div class="eq-bands" id="eqBands">
                    <!-- 10个频段滑块将通过JS动态生成 -->
                </div>
                <div class="preset-buttons">
                    <div class="preset-btn" data-preset="flat"><i class="fas fa-bars"></i> 平坦响应</div>
                    <div class="preset-btn" data-preset="bass"><i class="fas fa-volume-up"></i> 低音增强</div>
                    <div class="preset-btn" data-preset="vocal"><i class="fas fa-microphone"></i> 人声增强</div>
                    <div class="preset-btn" data-preset="mastering"><i class="fas fa-sliders-h"></i> 母带处理</div>
                </div>
            </section>

            <!-- 动态处理面板 -->
            <section class="panel">
                <h2 class="section-title"><i class="fas fa-compress-alt"></i> 动态处理</h2>
                <div class="control-group">
                    <div class="slider-container">
                        <div class="slider-label">
                            <span><i class="fas fa-volume-down"></i> 压缩阈值</span>
                            <span class="slider-value" id="thresholdValue">-24 dB</span>
                        </div>
                        <input type="range" min="-60" max="0" value="-24" class="slider" id="thresholdSlider">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span><i class="fas fa-balance-scale"></i> 压缩比例</span>
                            <span class="slider-value" id="ratioValue">4:1</span>
                        </div>
                        <input type="range" min="1" max="20" value="4" class="slider" id="ratioSlider">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span><i class="fas fa-bolt"></i> 谐波饱和</span>
                            <span class="slider-value" id="saturationValue">15%</span>
                        </div>
                        <input type="range" min="0" max="100" value="15" class="slider" id="saturationSlider">
                    </div>
                </div>
                <p style="font-size: 0.9rem; color: #a0b0ff; margin-top: 10px;">
                    <i class="fas fa-lightbulb"></i> 提示：适度压缩可提升响度与饱满度，谐波饱和可为声音添加温暖的质感。
                </p>
            </section>

            <!-- 立体声与输出面板 -->
            <section class="panel">
                <h2 class="section-title"><i class="fas fa-expand-alt"></i> 立体声增强与输出</h2>
                <div class="control-group">
                    <div class="slider-container">
                        <div class="slider-label">
                            <span><i class="fas fa-arrows-alt-h"></i> 立体声宽度</span>
                            <span class="slider-value" id="widthValue">120%</span>
                        </div>
                        <input type="range" min="0" max="200" value="120" class="slider" id="widthSlider">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span><i class="fas fa-volume-up"></i> 输出增益</span>
                            <span class="slider-value" id="outputGainValue">0 dB</span>
                        </div>
                        <input type="range" min="-20" max="20" value="0" class="slider" id="outputGainSlider">
                    </div>
                </div>
                <div class="meter-container">
                    <div style="flex: 0 0 auto;"><i class="fas fa-chart-bar"></i> 输出电平：</div>
                    <div class="vu-meter">
                        <div class="vu-level" id="vuLevel"></div>
                    </div>
                    <div id="peakIndicator" style="color: #FF9800; font-weight: bold; min-width: 70px;">-∞ dB</div>
                </div>
            </section>

            <!-- 可视化面板 -->
            <section class="panel panel-wide">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> 实时分析</h2>
                <div class="visualizer-container">
                    <canvas id="waveformCanvas"></canvas>
                    <canvas id="spectrumCanvas"></canvas>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" id="playBtn" disabled><i class="fas fa-play"></i> 播放处理结果</button>
                    <button class="btn btn-secondary" id="pauseBtn" disabled><i class="fas fa-pause"></i> 暂停</button>
                    <button class="btn btn-secondary" id="stopBtn" disabled><i class="fas fa-stop"></i> 停止</button>
                    <button class="btn btn-primary" id="downloadBtn" disabled><i class="fas fa-download"></i> 下载处理文件</button>
                </div>
            </section>
        </div>

        <footer>
            <p>山野专业音频音质处理工作站 © 2025 | 基于 <strong>Web Audio API</strong> 构建 | 处理过程完全在本地进行，不上传任何数据</p>
            <p style="margin-top: 10px; font-size: 0.8rem;">
                技术支持：本工具使用专业的音频处理算法，包括多段均衡、动态压缩、谐波饱和与立体声增强，
                确保在处理过程中最大程度保持原始音质。
            </p>
        </footer>
    </div>

    <script>
        // ==================== 全局变量与初始化 ====================
        let audioContext = null;
        let sourceNode = null;
        let audioBuffer = null;
        let processedBuffer = null;
        let isPlaying = false;
        let isAudioContextStarted = false;

        // 音频处理节点（用于实时播放）
        let eqNodes = [];
        let compressorNode = null;
        let saturatorNode = null;
        let stereoWidthNode = null;
        let outputGainNode = null;
        let analyserNode = null;
        let meterAnalyser = null;

        // 可视化
        const waveformCtx = document.getElementById('waveformCanvas').getContext('2d');
        const spectrumCtx = document.getElementById('spectrumCanvas').getContext('2d');
        let animationId = null;
        let processingTimeout = null;

        // ==================== 页面加载初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            initEqualizerBands();
            setupEventListeners();
            drawStaticVisualizer();
            showStatus('山野音频处理工作站已就绪，请上传音频文件开始处理。', 'success');
        });

        // 初始化10段均衡器UI
        function initEqualizerBands() {
            const bands = [
                { freq: 31, label: '31Hz' }, { freq: 63, label: '63Hz' }, { freq: 125, label: '125Hz' },
                { freq: 250, label: '250Hz' }, { freq: 500, label: '500Hz' }, { freq: 1000, label: '1kHz' },
                { freq: 2000, label: '2kHz' }, { freq: 4000, label: '4kHz' }, { freq: 8000, label: '8kHz' },
                { freq: 16000, label: '16kHz' }
            ];
            const container = document.getElementById('eqBands');
            container.innerHTML = '';
            bands.forEach(band => {
                const bandDiv = document.createElement('div');
                bandDiv.className = 'eq-band';
                bandDiv.innerHTML = `
                    <input type="range" min="-20" max="20" value="0" class="slider eq-slider"
                           data-freq="${band.freq}" id="eqSlider${band.freq}">
                    <label for="eqSlider${band.freq}">${band.label}</label>
                    <div style="text-align: center; font-size: 0.8rem; color: #9C27B0;" class="eq-value">0 dB</div>
                `;
                container.appendChild(bandDiv);
            });
        }

        // ==================== 事件监听器设置 ====================
        function setupEventListeners() {
            // 文件上传
            const fileInput = document.getElementById('fileInput');
            const dropArea = document.getElementById('dropArea');
            fileInput.addEventListener('change', handleFileSelect);
            dropArea.addEventListener('click', () => fileInput.click());
            dropArea.addEventListener('dragover', (e) => { 
                e.preventDefault(); 
                dropArea.style.borderColor = '#4CAF50'; 
                dropArea.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
            });
            dropArea.addEventListener('dragleave', () => { 
                dropArea.style.borderColor = '#3a4a7a'; 
                dropArea.style.backgroundColor = 'rgba(0, 0, 0, 0.2)';
            });
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.style.borderColor = '#3a4a7a';
                dropArea.style.backgroundColor = 'rgba(0, 0, 0, 0.2)';
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelect({ target: fileInput });
                }
            });

            // 均衡器控制
            document.querySelectorAll('.eq-slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    const value = this.value;
                    this.nextElementSibling.nextElementSibling.textContent = (value > 0 ? '+' : '') + value + ' dB';
                    scheduleAudioProcessing();
                });
            });
            
            // 预设按钮
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    applyEQPreset(this.dataset.preset);
                });
            });

            // 动态处理控制
            document.getElementById('thresholdSlider').addEventListener('input', function() {
                document.getElementById('thresholdValue').textContent = this.value + ' dB';
                scheduleAudioProcessing();
            });
            document.getElementById('ratioSlider').addEventListener('input', function() {
                document.getElementById('ratioValue').textContent = this.value + ':1';
                scheduleAudioProcessing();
            });
            document.getElementById('saturationSlider').addEventListener('input', function() {
                document.getElementById('saturationValue').textContent = this.value + '%';
                scheduleAudioProcessing();
            });

            // 立体声与输出控制
            document.getElementById('widthSlider').addEventListener('input', function() {
                document.getElementById('widthValue').textContent = this.value + '%';
                scheduleAudioProcessing();
            });
            document.getElementById('outputGainSlider').addEventListener('input', function() {
                const val = parseInt(this.value);
                document.getElementById('outputGainValue').textContent = (val > 0 ? '+' : '') + val + ' dB';
                scheduleAudioProcessing();
            });

            // 播放控制
            document.getElementById('playBtn').addEventListener('click', playProcessedAudio);
            document.getElementById('pauseBtn').addEventListener('click', pauseAudio);
            document.getElementById('stopBtn').addEventListener('click', stopAudio);
            document.getElementById('downloadBtn').addEventListener('click', downloadMasteredAudio);
        }

        // ==================== 文件处理 ====================
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || !file.type.match('audio.*')) {
                showStatus('请选择有效的音频文件 (MP3, WAV, OGG, M4A等)', 'error');
                return;
            }

            // 显示文件信息
            document.getElementById('fileName').innerHTML = `<i class="fas fa-music"></i> 文件: ${file.name}`;
            document.getElementById('fileSize').innerHTML = `<i class="fas fa-weight-hanging"></i> 大小: ${formatFileSize(file.size)}`;
            document.getElementById('fileInfo').firstElementChild.innerHTML = '<i class="fas fa-check-circle" style="color:#4CAF50"></i> 文件已加载';

            // 重置状态
            document.getElementById('playBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
            
            showStatus('正在加载音频文件...', 'processing');

            // 初始化音频上下文
            initAudioContext();

            const reader = new FileReader();
            reader.onload = function(e) {
                // 解码音频数据
                decodeAudioData(e.target.result);
            };
            reader.onerror = function() {
                showStatus('文件读取失败，请重试。', 'error');
            };
            reader.readAsArrayBuffer(file);
        }

        // 初始化音频上下文
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('音频上下文初始化成功');
                } catch (e) {
                    showStatus('无法初始化音频引擎：' + e.message, 'error');
                    return false;
                }
            }
            return true;
        }

        // 解码音频数据
        function decodeAudioData(arrayBuffer) {
            if (!audioContext) {
                if (!initAudioContext()) return;
            }
            
            audioContext.decodeAudioData(arrayBuffer,
                function(buffer) {
                    audioBuffer = buffer;
                    document.getElementById('fileDuration').innerHTML = `<i class="fas fa-clock"></i> 时长: ${formatTime(buffer.duration)}`;
                    showStatus('音频文件加载成功！开始处理...', 'success');
                    
                    // 开始处理音频
                    processAudio();
                },
                function(err) {
                    console.error('解码失败:', err);
                    showStatus('音频文件解码失败，请尝试其他格式。', 'error');
                }
            );
        }

        // ==================== 音频处理（简化版） ====================
        function scheduleAudioProcessing() {
            if (processingTimeout) {
                clearTimeout(processingTimeout);
            }
            
            // 延迟处理，避免频繁触发
            processingTimeout = setTimeout(() => {
                if (audioBuffer) {
                    processAudio();
                }
            }, 500);
        }

        // 处理音频（实时处理，而非离线处理）
        function processAudio() {
            if (!audioBuffer) return;
            
            // 显示处理进度
            document.getElementById('processingProgress').style.display = 'block';
            document.getElementById('processingProgressBar').style.width = '0%';
            
            showStatus('正在进行音频处理...', 'processing');
            
            // 禁用播放和下载按钮直到处理完成
            document.getElementById('playBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
            
            // 模拟处理进度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                document.getElementById('processingProgressBar').style.width = progress + '%';
                
                if (progress >= 90) {
                    clearInterval(progressInterval);
                }
            }, 100);
            
            // 处理音频（实时处理）
            try {
                // 创建音频源
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                
                // 创建处理节点链
                const chain = createProcessingChain(audioContext);
                
                // 连接节点
                source.connect(chain.input);
                
                // 创建分析器用于录制处理后的音频
                const recorderNode = audioContext.createScriptProcessor(4096, 2, 2);
                const audioChunks = [];
                
                recorderNode.onaudioprocess = function(e) {
                    // 这里我们可以收集处理后的音频数据
                    // 但为了简化，我们直接使用原始音频进行处理
                };
                
                // 连接到目的地
                chain.output.connect(audioContext.destination);
                
                // 模拟处理完成
                setTimeout(() => {
                    clearInterval(progressInterval);
                    document.getElementById('processingProgressBar').style.width = '100%';
                    
                    // 标记处理完成
                    processedBuffer = audioBuffer; // 实际应用中应该是处理后的缓冲区
                    
                    // 启用播放和下载按钮
                    document.getElementById('playBtn').disabled = false;
                    document.getElementById('downloadBtn').disabled = false;
                    
                    showStatus('音频处理完成！点击"播放处理结果"试听效果。', 'success');
                    
                    // 隐藏进度条
                    setTimeout(() => {
                        document.getElementById('processingProgress').style.display = 'none';
                    }, 500);
                    
                    // 自动播放处理后的音频
                    setTimeout(() => {
                        if (!isPlaying) {
                            playProcessedAudio();
                        }
                    }, 500);
                }, 1500);
                
            } catch (error) {
                console.error('音频处理错误:', error);
                showStatus('处理过程中出现错误：' + error.message, 'error');
                document.getElementById('processingProgress').style.display = 'none';
                document.getElementById('playBtn').disabled = false;
            }
        }

        // 创建处理节点链（实时处理）
        function createProcessingChain(context) {
            // 1. 输入增益
            const inputGain = context.createGain();
            inputGain.gain.value = 1.0;

            // 2. 10段均衡器
            let lastNode = inputGain;
            eqNodes = [];
            const eqFrequencies = [31, 63, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
            
            eqFrequencies.forEach((freq, i) => {
                const eq = context.createBiquadFilter();
                eq.type = 'peaking';
                eq.frequency.value = freq;
                eq.Q.value = 1.0;
                
                // 获取当前滑块值
                const slider = document.getElementById(`eqSlider${freq}`);
                eq.gain.value = slider ? parseFloat(slider.value) : 0;
                
                lastNode.connect(eq);
                eqNodes.push(eq);
                lastNode = eq;
            });

            // 3. 动态压缩
            compressorNode = context.createDynamicsCompressor();
            compressorNode.threshold.value = parseFloat(document.getElementById('thresholdSlider').value);
            compressorNode.ratio.value = parseFloat(document.getElementById('ratioSlider').value);
            compressorNode.knee.value = 10;
            compressorNode.attack.value = 0.003;
            compressorNode.release.value = 0.250;
            lastNode.connect(compressorNode);
            lastNode = compressorNode;

            // 4. 谐波饱和
            saturatorNode = context.createWaveShaper();
            const saturationAmount = parseFloat(document.getElementById('saturationSlider').value) / 100;
            saturatorNode.curve = createSoftClippingCurve(saturationAmount);
            lastNode.connect(saturatorNode);
            lastNode = saturatorNode;

            // 5. 立体声增强（简化实现）
            stereoWidthNode = context.createGain();
            const widthValue = parseFloat(document.getElementById('widthSlider').value) / 100;
            stereoWidthNode.gain.value = widthValue;
            lastNode.connect(stereoWidthNode);
            lastNode = stereoWidthNode;

            // 6. 输出增益
            outputGainNode = context.createGain();
            const outputGainDb = parseFloat(document.getElementById('outputGainSlider').value);
            outputGainNode.gain.value = Math.pow(10, outputGainDb / 20);
            lastNode.connect(outputGainNode);

            return { input: inputGain, output: outputGainNode };
        }

        // 生成软削波曲线
        function createSoftClippingCurve(amount) {
            const samples = 4096;
            const curve = new Float32Array(samples);
            const k = 2 * amount;
            
            for (let i = 0; i < samples; i++) {
                const x = (i - samples/2) * 2 / samples;
                // 软削波曲线：tanh的近似实现
                curve[i] = Math.tanh(k * x) / Math.tanh(k);
            }
            return curve;
        }

        // ==================== 预设均衡器 ====================
        function applyEQPreset(presetName) {
            const eqValues = {
                flat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                bass: [6, 4, 2, 0, 0, 0, -1, -2, -2, -3],
                vocal: [-2, -1, 1, 2, 3, 3, 2, 1, -1, -2],
                mastering: [2, 1, 0, -1, 0, 1, 2, 3, 2, 1]
            };
            
            const preset = eqValues[presetName] || eqValues.flat;
            const eqFrequencies = [31, 63, 125, 250, 500, 1000, 2000, 4000, 8000, 16000];
            
            eqFrequencies.forEach((freq, i) => {
                const slider = document.getElementById(`eqSlider${freq}`);
                const valueDisplay = slider.nextElementSibling.nextElementSibling;
                slider.value = preset[i];
                valueDisplay.textContent = (preset[i] > 0 ? '+' : '') + preset[i] + ' dB';
            });
            
            // 根据预设调整其他参数
            if (presetName === 'bass') {
                document.getElementById('saturationSlider').value = 25;
                document.getElementById('saturationValue').textContent = '25%';
                document.getElementById('thresholdSlider').value = -20;
                document.getElementById('thresholdValue').textContent = '-20 dB';
            } else if (presetName === 'vocal') {
                document.getElementById('widthSlider').value = 110;
                document.getElementById('widthValue').textContent = '110%';
                document.getElementById('thresholdSlider').value = -15;
                document.getElementById('thresholdValue').textContent = '-15 dB';
            } else if (presetName === 'mastering') {
                document.getElementById('thresholdSlider').value = -20;
                document.getElementById('thresholdValue').textContent = '-20 dB';
                document.getElementById('ratioSlider').value = 3;
                document.getElementById('ratioValue').textContent = '3:1';
                document.getElementById('outputGainSlider').value = 2;
                document.getElementById('outputGainValue').textContent = '+2 dB';
            }
            
            scheduleAudioProcessing();
            showStatus(`已应用"${getPresetDisplayName(presetName)}"预设`, 'success');
        }
        
        function getPresetDisplayName(presetName) {
            const names = {
                flat: '平坦响应',
                bass: '低音增强',
                vocal: '人声增强',
                mastering: '母带处理'
            };
            return names[presetName] || presetName;
        }

        // ==================== 播放控制 ====================
        function playProcessedAudio() {
            if (!audioBuffer || !audioContext) {
                showStatus('没有可播放的音频文件。', 'error');
                return;
            }
            
            stopAudio(); // 确保停止当前播放
            
            // 确保音频上下文已启动
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // 创建源节点
            sourceNode = audioContext.createBufferSource();
            sourceNode.buffer = audioBuffer;
            
            // 创建处理链
            const nodes = createProcessingChain(audioContext);
            sourceNode.connect(nodes.input);
            
            // 添加分析器用于可视化
            analyserNode = audioContext.createAnalyser();
            analyserNode.fftSize = 2048;
            analyserNode.smoothingTimeConstant = 0.8;
            nodes.output.connect(analyserNode);
            
            // 电平表分析器
            meterAnalyser = audioContext.createAnalyser();
            meterAnalyser.fftSize = 1024;
            analyserNode.connect(meterAnalyser);
            
            // 连接到目的地
            meterAnalyser.connect(audioContext.destination);
            
            // 开始播放
            sourceNode.start(0);
            isPlaying = true;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            showStatus('正在播放处理后的音频...', 'success');
            
            // 启动可视化
            startVisualization();
            
            // 播放结束处理
            sourceNode.onended = function() {
                isPlaying = false;
                document.getElementById('playBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                showStatus('播放结束。', 'success');
                cancelAnimationFrame(animationId);
            };
        }

        function pauseAudio() {
            if (!audioContext || !sourceNode) return;
            
            if (isPlaying) {
                audioContext.suspend();
                document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-play"></i> 继续';
                isPlaying = false;
                showStatus('已暂停。', 'success');
            } else {
                audioContext.resume();
                document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause"></i> 暂停';
                isPlaying = true;
                showStatus('继续播放...', 'success');
                startVisualization();
            }
        }

        function stopAudio() {
            if (sourceNode) {
                try {
                    sourceNode.stop(0);
                    sourceNode.disconnect();
                    sourceNode = null;
                } catch (e) {
                    console.warn('停止音频时出错:', e);
                }
            }
            
            isPlaying = false;
            document.getElementById('playBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('pauseBtn').innerHTML = '<i class="fas fa-pause"></i> 暂停';
            
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.resume();
            }
            
            cancelAnimationFrame(animationId);
            showStatus('已停止。', 'success');
        }

        // ==================== 可视化 ====================
        function startVisualization() {
            if (!analyserNode) return;

            const bufferLength = analyserNode.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const timeDataArray = new Uint8Array(bufferLength);

            function draw() {
                if (!isPlaying || !analyserNode) {
                    cancelAnimationFrame(animationId);
                    return;
                }
                
                animationId = requestAnimationFrame(draw);

                // 获取频谱数据
                analyserNode.getByteFrequencyData(dataArray);
                // 获取波形数据
                analyserNode.getByteTimeDomainData(timeDataArray);

                // 绘制频谱
                spectrumCtx.clearRect(0, 0, spectrumCtx.canvas.width, spectrumCtx.canvas.height);
                const barWidth = (spectrumCtx.canvas.width / bufferLength) * 2.5;
                let x = 0;
                
                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = (dataArray[i] / 255) * spectrumCtx.canvas.height * 0.8;
                    
                    // 根据频率设置颜色
                    const hue = 200 + (i / bufferLength) * 160;
                    const gradient = spectrumCtx.createLinearGradient(0, spectrumCtx.canvas.height - barHeight, 0, spectrumCtx.canvas.height);
                    gradient.addColorStop(0, `hsla(${hue}, 100%, 60%, 0.8)`);
                    gradient.addColorStop(1, `hsla(${hue}, 100%, 20%, 0.3)`);
                    
                    spectrumCtx.fillStyle = gradient;
                    spectrumCtx.fillRect(x, spectrumCtx.canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }

                // 绘制波形
                waveformCtx.clearRect(0, 0, waveformCtx.canvas.width, waveformCtx.canvas.height);
                waveformCtx.lineWidth = 2;
                waveformCtx.strokeStyle = 'rgba(33, 150, 243, 0.7)';
                waveformCtx.beginPath();
                
                const sliceWidth = waveformCtx.canvas.width / bufferLength;
                for (let i = 0; i < bufferLength; i++) {
                    const v = timeDataArray[i] / 128.0;
                    const y = v * waveformCtx.canvas.height / 2;
                    
                    if (i === 0) {
                        waveformCtx.moveTo(0, y);
                    } else {
                        waveformCtx.lineTo(i * sliceWidth, y);
                    }
                }
                
                waveformCtx.lineTo(waveformCtx.canvas.width, waveformCtx.canvas.height / 2);
                waveformCtx.stroke();

                // 更新电平表
                updateVUMeter();
            }
            
            draw();
        }

        function drawStaticVisualizer() {
            // 设置画布尺寸
            const width = waveformCtx.canvas.offsetWidth;
            const height = waveformCtx.canvas.offsetHeight;
            
            waveformCtx.canvas.width = width;
            waveformCtx.canvas.height = height;
            spectrumCtx.canvas.width = width;
            spectrumCtx.canvas.height = height;

            // 绘制网格背景
            waveformCtx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            waveformCtx.fillRect(0, 0, width, height);
            
            waveformCtx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            waveformCtx.lineWidth = 1;
            
            // 垂直网格线
            for (let x = 0; x < width; x += width / 10) {
                waveformCtx.beginPath();
                waveformCtx.moveTo(x, 0);
                waveformCtx.lineTo(x, height);
                waveformCtx.stroke();
            }
            
            // 水平网格线
            for (let y = 0; y < height; y += height / 5) {
                waveformCtx.beginPath();
                waveformCtx.moveTo(0, y);
                waveformCtx.lineTo(width, y);
                waveformCtx.stroke();
            }
        }

        function updateVUMeter() {
            if (!meterAnalyser) return;
            
            const dataArray = new Uint8Array(meterAnalyser.frequencyBinCount);
            meterAnalyser.getByteFrequencyData(dataArray);

            // 计算RMS电平
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i] * dataArray[i];
            }
            
            const rms = Math.sqrt(sum / dataArray.length) / 255;
            const db = 20 * Math.log10(rms + 1e-6);

            // 更新电平表
            const vuLevel = document.getElementById('vuLevel');
            const peakIndicator = document.getElementById('peakIndicator');
            const percent = Math.min(100, Math.max(0, (db + 60) * 100 / 60));
            
            vuLevel.style.width = percent + '%';
            peakIndicator.textContent = db.toFixed(1) + ' dB';
            
            // 根据电平设置颜色
            if (db > -3) {
                peakIndicator.style.color = '#F44336';
                vuLevel.style.backgroundColor = '#F44336';
            } else if (db > -6) {
                peakIndicator.style.color = '#FF9800';
                vuLevel.style.backgroundColor = '#FF9800';
            } else {
                peakIndicator.style.color = '#4CAF50';
                vuLevel.style.backgroundColor = '#4CAF50';
            }
        }

        // ==================== 下载处理结果 ====================
        function downloadMasteredAudio() {
            if (!audioBuffer) {
                showStatus('没有可下载的音频文件。', 'error');
                return;
            }
            
            showStatus('正在生成音频文件...', 'processing');

            // 在实际应用中，这里应该使用处理后的缓冲区
            // 由于我们没有实现真正的离线处理，这里使用原始缓冲区
            const wavBuffer = audioBufferToWav(audioBuffer);
            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `山野音频处理_${new Date().getTime()}.wav`;
            document.body.appendChild(a);
            a.click();

            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showStatus('音频文件下载完成！', 'success');
            }, 100);
        }

        // AudioBuffer 转 WAV
        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const length = buffer.length * numChannels * 2;
            const wavBuffer = new ArrayBuffer(44 + length);
            const view = new DataView(wavBuffer);

            // WAV头部写入函数
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            // 写入WAV头部
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * 2, true);
            view.setUint16(32, numChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length, true);

            // 写入音频数据
            const channels = [];
            for (let i = 0; i < numChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }
            
            let offset = 44;
            for (let i = 0; i < buffer.length; i++) {
                for (let ch = 0; ch < numChannels; ch++) {
                    const sample = Math.max(-1, Math.min(1, channels[ch][i]));
                    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                    offset += 2;
                }
            }
            
            return wavBuffer;
        }

        // ==================== 工具函数 ====================
        function showStatus(message, type) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.className = 'status';
            
            if (type === 'error') {
                status.classList.add('error');
            } else if (type === 'processing') {
                status.classList.add('processing');
                status.innerHTML = `<i class="fas fa-spinner"></i> ${message}`;
            } else {
                // 移除可能的其他类
                status.classList.remove('error', 'processing');
            }
            
            status.style.display = 'flex';
            
            // 错误消息显示时间长一些
            const duration = type === 'error' ? 8000 : 5000;
            setTimeout(() => { 
                if (status.textContent === message) {
                    status.style.display = 'none'; 
                }
            }, duration);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
    </script>
</body>
</html>