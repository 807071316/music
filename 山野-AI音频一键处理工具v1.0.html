<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>山野-AI音频一键处理工具</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1b4332 0%, #2d6a4f 50%, #40916c 100%);
            color: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: rgba(29, 53, 45, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(76, 145, 112, 0.3);
        }
        
        /* 密码保护层 */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1b4332 0%, #2d6a4f 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .password-box {
            background-color: rgba(29, 53, 45, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 90%;
            max-width: 450px;
            border: 2px solid #40916c;
        }
        
        .password-box h2 {
            color: #d8f3dc;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .password-box p {
            color: #95d5b2;
            margin-bottom: 30px;
            font-size: 0.95rem;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #52b788;
            border-radius: 10px;
            background-color: rgba(45, 106, 79, 0.7);
            color: #f8f9fa;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #74c69d;
            box-shadow: 0 0 10px rgba(116, 198, 157, 0.5);
        }
        
        .password-btn {
            background: linear-gradient(to right, #40916c, #2d6a4f);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            width: 100%;
        }
        
        .password-btn:hover {
            background: linear-gradient(to right, #52b788, #40916c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(64, 145, 108, 0.4);
        }
        
        .password-error {
            color: #ff6b6b;
            margin-top: 15px;
            display: none;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(76, 145, 112, 0.3);
        }
        
        h1 {
            color: #d8f3dc;
            margin-bottom: 10px;
            font-size: 2.5rem;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            color: #b7e4c7;
            font-size: 1.1rem;
            margin-top: 5px;
            font-weight: 300;
        }
        
        .version-info {
            margin-top: 8px;
            color: #95d5b2;
            font-size: 0.85rem;
            font-style: italic;
        }
        
        .warning-box {
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .warning-box h3 {
            color: #ffc107;
            margin-bottom: 8px;
        }
        
        .zone-selector {
            display: flex;
            gap: 20px;
            margin: 30px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .zone-card {
            background: linear-gradient(145deg, rgba(45, 106, 79, 0.8), rgba(29, 53, 45, 0.8));
            border-radius: 15px;
            padding: 30px;
            width: 350px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }
        
        .zone-card.active {
            border-color: #52b788;
            box-shadow: 0 10px 25px rgba(82, 183, 136, 0.3);
        }
        
        .zone-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .zone-card.disabled:hover {
            transform: none;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .zone-card:hover:not(.disabled) {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        
        .zone-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
        }
        
        .vocal-icon {
            color: #ff6b6b;
        }
        
        .instrumental-icon {
            color: #74c69d;
        }
        
        .zone-title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #d8f3dc;
        }
        
        .zone-description {
            color: #b7e4c7;
            margin-bottom: 25px;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .beta-tag {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ffc107;
            color: #1b4332;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .preset-selector {
            margin-top: 20px;
        }
        
        .preset-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            background-color: rgba(64, 145, 108, 0.7);
            color: #f8f9fa;
            border: 2px solid rgba(116, 198, 157, 0.5);
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
            min-width: 140px;
            max-width: 180px;
        }
        
        .preset-btn.active {
            background-color: #52b788;
            border-color: #52b788;
            box-shadow: 0 5px 15px rgba(82, 183, 136, 0.3);
        }
        
        .preset-btn:hover:not(.active):not(:disabled) {
            background-color: rgba(82, 183, 136, 0.7);
            border-color: #74c69d;
        }
        
        .preset-btn:disabled {
            background-color: rgba(60, 60, 60, 0.5);
            border-color: rgba(100, 100, 100, 0.5);
            color: #888;
            cursor: not-allowed;
        }
        
        .upload-section {
            background: linear-gradient(145deg, rgba(45, 106, 79, 0.7), rgba(29, 53, 45, 0.7));
            border: 3px dashed rgba(116, 198, 157, 0.5);
            border-radius: 15px;
            padding: 50px 20px;
            text-align: center;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            background: linear-gradient(145deg, rgba(64, 145, 108, 0.7), rgba(45, 106, 79, 0.7));
            border-color: #74c69d;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #74c69d;
            margin-bottom: 20px;
        }
        
        .upload-section h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #d8f3dc;
        }
        
        .upload-section p {
            color: #b7e4c7;
            font-size: 0.95rem;
        }
        
        .upload-section input {
            display: none;
        }
        
        .audio-info {
            display: none;
            background-color: rgba(29, 53, 45, 0.7);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }
        
        .audio-info h3 {
            color: #74c69d;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .file-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            background-color: rgba(45, 106, 79, 0.5);
            padding: 12px;
            border-radius: 10px;
        }
        
        .detail-label {
            font-size: 0.9rem;
            color: #b7e4c7;
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-size: 1rem;
            color: #f8f9fa;
            font-weight: 500;
        }
        
        .audio-player {
            background-color: rgba(45, 106, 79, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .player-title {
            color: #74c69d;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
        }
        
        audio {
            width: 100%;
            margin-top: 10px;
            border-radius: 10px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .action-btn {
            background: linear-gradient(to right, #40916c, #2d6a4f);
            color: white;
            border: none;
            padding: 16px 35px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 200px;
            box-shadow: 0 5px 15px rgba(64, 145, 108, 0.3);
        }
        
        .action-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(64, 145, 108, 0.4);
        }
        
        .action-btn:disabled {
            background: linear-gradient(to right, #495057, #6c757d);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #processBtn {
            background: linear-gradient(to right, #52b788, #40916c);
            box-shadow: 0 5px 15px rgba(82, 183, 136, 0.3);
        }
        
        #processBtn:hover:not(:disabled) {
            box-shadow: 0 8px 20px rgba(82, 183, 136, 0.4);
        }
        
        #downloadBtn {
            background: linear-gradient(to right, #74c69d, #52b788);
            box-shadow: 0 5px 15px rgba(116, 198, 157, 0.3);
        }
        
        #downloadBtn:hover:not(:disabled) {
            box-shadow: 0 8px 20px rgba(116, 198, 157, 0.4);
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
            font-weight: 500;
        }
        
        .processing {
            background-color: rgba(82, 183, 136, 0.15);
            color: #52b788;
            border-left: 4px solid #52b788;
        }
        
        .success {
            background-color: rgba(46, 204, 113, 0.15);
            color: #2ecc71;
            border-left: 4px solid #2ecc71;
        }
        
        .error {
            background-color: rgba(255, 107, 107, 0.15);
            color: #ff6b6b;
            border-left: 4px solid #ff6b6b;
        }
        
        .processed-audio {
            display: none;
            background-color: rgba(29, 53, 45, 0.7);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }
        
        .processed-audio h3 {
            color: #52b788;
            margin-bottom: 15px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .processing-details {
            text-align: center;
            margin-bottom: 20px;
            color: #b7e4c7;
            font-size: 0.95rem;
        }
        
        footer {
            margin-top: 40px;
            text-align: center;
            font-size: 0.9rem;
            color: #95d5b2;
            border-top: 1px solid rgba(76, 145, 112, 0.3);
            padding-top: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .zone-card {
                width: 100%;
                max-width: 350px;
            }
            
            .action-btn {
                min-width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .preset-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .preset-btn {
                max-width: 100%;
                width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 密码保护层 -->
    <div class="password-overlay" id="passwordOverlay">
        <div class="password-box">
            <h2><i class="fas fa-mountain"></i> 山野-AI音频处理工具</h2>
            <p>请输入访问密码以使用本工具</p>
            <input type="password" class="password-input" id="passwordInput" placeholder="请输入访问密码">
            <button class="password-btn" id="passwordBtn">进入工具</button>
            <div class="password-error" id="passwordError">密码错误，请重新输入</div>
        </div>
    </div>
    
    <div class="container" id="mainContainer" style="display: none;">
        <header>
            <h1><i class="fas fa-mountain"></i> 山野-AI音频一键处理工具</h1>
            <p class="subtitle">智能音频优化，让AI音频通过平台检测</p>
            <p class="version-info">版本 V2.0 | 纯音乐模式已启用 | 人声模式开发中</p>
        </header>
        
        <div class="warning-box">
            <h3><i class="fas fa-exclamation-triangle"></i> 使用声明</h3>
            <p>本工具仅供处理您拥有合法版权的音频文件。请确保您拥有所处理音频的相应权利。未经授权处理受版权保护的音频可能违反相关法律法规。</p>
        </div>
        
        <div class="zone-selector">
            <div class="zone-card" id="vocalZone">
                <div class="beta-tag">内测中</div>
                <div class="zone-icon vocal-icon">
                    <i class="fas fa-microphone-alt"></i>
                </div>
                <h3 class="zone-title">人声专区</h3>
                <p class="zone-description">内测中，功能尚不完善，请谨慎使用。专门优化带人声音频，使其通过AI检测平台。</p>
                <div class="preset-selector">
                    <div class="preset-buttons">
                        <button class="preset-btn active" id="vocalStandardPreset">标准优化</button>
                        <button class="preset-btn" id="vocalEnhancedPreset">增强优化</button>
                    </div>
                </div>
            </div>
            
            <div class="zone-card active" id="instrumentalZone">
                <div class="zone-icon instrumental-icon">
                    <i class="fas fa-guitar"></i>
                </div>
                <h3 class="zone-title">纯音乐专区</h3>
                <p class="zone-description">优化纯音乐、伴奏、BGM等音频，调整频谱特征以提高通过AI检测的概率。一键处理，操作简单。</p>
                <div class="preset-selector">
                    <div class="preset-buttons">
                        <button class="preset-btn active" id="standardPreset">标准优化</button>
                        <button class="preset-btn" id="enhancedPreset">增强优化</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="upload-section" id="dropArea">
            <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h3>点击或拖放音频文件</h3>
            <p>支持 MP3, WAV, OGG, M4A, FLAC 格式</p>
            <input type="file" id="audioUpload" accept="audio/*">
        </div>
        
        <div class="audio-info" id="audioInfo">
            <h3><i class="fas fa-music"></i> 已加载音频信息</h3>
            <div class="file-details">
                <div class="detail-item">
                    <div class="detail-label">文件名</div>
                    <div class="detail-value" id="fileName">未选择</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">时长</div>
                    <div class="detail-value" id="fileDuration">--:--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">文件大小</div>
                    <div class="detail-value" id="fileSize">0 MB</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">处理模式</div>
                    <div class="detail-value" id="processingMode">纯音乐专区 - 标准优化</div>
                </div>
            </div>
            
            <div class="audio-player">
                <div class="player-title">原始音频预览</div>
                <audio id="originalAudio" controls></audio>
            </div>
        </div>
        
        <div class="action-buttons">
            <button id="processBtn" class="action-btn" disabled>
                <i class="fas fa-cogs"></i> 一键处理音频
            </button>
            <button id="downloadBtn" class="action-btn" disabled>
                <i class="fas fa-download"></i> 下载处理结果
            </button>
        </div>
        
        <div class="status" id="status"></div>
        
        <div class="processed-audio" id="processedAudioSection">
            <h3><i class="fas fa-headphones"></i> 处理完成！</h3>
            <div class="processing-details" id="processingDetails">
                音频已优化完成，可下载使用
            </div>
            
            <div class="audio-player">
                <div class="player-title">处理后的音频</div>
                <audio id="processedAudio" controls></audio>
            </div>
        </div>
        
        <footer>
            <p>本工具使用Web Audio API在浏览器中处理音频，所有处理都在本地完成，不会上传到任何服务器。</p>
            <p>仅供合法用途 | © 2023 山野-AI音频一键处理工具 | 版本 V2.0</p>
        </footer>
    </div>

    <script>
        // 密码验证
        const PASSWORD = "syyy8090";
        const passwordOverlay = document.getElementById('passwordOverlay');
        const mainContainer = document.getElementById('mainContainer');
        const passwordInput = document.getElementById('passwordInput');
        const passwordBtn = document.getElementById('passwordBtn');
        const passwordError = document.getElementById('passwordError');
        
        // 检查是否已经通过密码验证
        const isAuthenticated = localStorage.getItem('shanYeAuthenticated') === 'true';
        
        if (isAuthenticated) {
            passwordOverlay.style.display = 'none';
            mainContainer.style.display = 'block';
        } else {
            passwordOverlay.style.display = 'flex';
        }
        
        // 密码验证函数
        function verifyPassword() {
            const enteredPassword = passwordInput.value.trim();
            
            if (enteredPassword === PASSWORD) {
                // 密码正确，隐藏密码层，显示主界面
                passwordOverlay.style.display = 'none';
                mainContainer.style.display = 'block';
                
                // 记录认证状态（有效期24小时）
                localStorage.setItem('shanYeAuthenticated', 'true');
                const expirationTime = new Date().getTime() + 24 * 60 * 60 * 1000;
                localStorage.setItem('shanYeAuthExpire', expirationTime.toString());
                
                console.log("密码验证成功，工具已解锁");
            } else {
                // 密码错误
                passwordError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
                
                // 添加错误动画效果
                passwordInput.style.borderColor = '#ff6b6b';
                passwordInput.style.boxShadow = '0 0 10px rgba(255, 107, 107, 0.5)';
                
                setTimeout(() => {
                    passwordInput.style.borderColor = '#52b788';
                    passwordInput.style.boxShadow = 'none';
                }, 500);
            }
        }
        
        // 密码输入事件监听
        passwordBtn.addEventListener('click', verifyPassword);
        
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyPassword();
            }
        });
        
        // 检查认证是否过期
        function checkAuthExpiration() {
            const expireTime = localStorage.getItem('shanYeAuthExpire');
            if (expireTime && new Date().getTime() > parseInt(expireTime)) {
                localStorage.removeItem('shanYeAuthenticated');
                localStorage.removeItem('shanYeAuthExpire');
                location.reload();
            }
        }
        
        // 定期检查认证状态
        setInterval(checkAuthExpiration, 60000); // 每分钟检查一次
        
        // 工具主逻辑
        // 全局变量
        let audioContext;
        let audioBuffer;
        let processedAudioBuffer;
        let currentZone = 'instrumental'; // 'instrumental' 或 'vocal'
        let currentPreset = 'standard'; // 每个专区各自的预设
        
        // 预设配置 - 修改了人声专区的增强优化参数
        const presetConfigs = {
            instrumental: {
                standard: {
                    name: "标准优化",
                    description: "平衡音质和检测通过率，适合大多数纯音乐",
                    speed: 0.98,
                    pitch: 2,
                    treble: 30
                },
                enhanced: {
                    name: "增强优化",
                    description: "更强的优化效果，适合较难通过检测的音频",
                    speed: 0.96,
                    pitch: 3,
                    treble: 40
                }
            },
            vocal: {
                standard: {
                    name: "标准优化",
                    description: "平衡音质和检测通过率，适合大多数人声音频",
                    speed: 0.98,
                    pitch: 2,
                    treble: 30
                },
                enhanced: {
                    name: "增强优化",
                    description: "更强的优化效果，适合较难通过检测的人声音频",
                    speed: 0.97,      // 修改：速度因子 0.97x
                    pitch: 0,         // 修改：音高调整 +0 半音
                    treble: 30,       // 修改：高频削减 30%
                    normalization: 0  // 添加：音量标准化 0 dBFS
                }
            }
        };
        
        // DOM元素
        const audioUpload = document.getElementById('audioUpload');
        const dropArea = document.getElementById('dropArea');
        const audioInfo = document.getElementById('audioInfo');
        const originalAudio = document.getElementById('originalAudio');
        const processedAudio = document.getElementById('processedAudio');
        const processedAudioSection = document.getElementById('processedAudioSection');
        
        // 按钮元素
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        
        // 专区元素
        const vocalZone = document.getElementById('vocalZone');
        const instrumentalZone = document.getElementById('instrumentalZone');
        
        // 预设按钮元素
        const standardPresetBtn = document.getElementById('standardPreset');
        const enhancedPresetBtn = document.getElementById('enhancedPreset');
        const vocalStandardPresetBtn = document.getElementById('vocalStandardPreset');
        const vocalEnhancedPresetBtn = document.getElementById('vocalEnhancedPreset');
        
        // 状态显示
        const status = document.getElementById('status');
        const processingDetails = document.getElementById('processingDetails');
        const processingMode = document.getElementById('processingMode');
        
        // 初始化工具主逻辑
        function initTool() {
            console.log("山野-AI音频一键处理工具初始化完成 - 版本 V2.0");
            setupEventListeners();
        }
        
        // 当主界面显示后初始化工具
        if (isAuthenticated) {
            initTool();
        } else {
            // 等待密码验证成功后初始化
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'style' && mainContainer.style.display === 'block') {
                        initTool();
                        observer.disconnect();
                    }
                });
            });
            
            observer.observe(mainContainer, { attributes: true });
        }
        
        function setupEventListeners() {
            // 文件上传
            audioUpload.addEventListener('change', handleFileSelect);
            
            // 拖放功能
            dropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropArea.style.borderColor = '#74c69d';
                dropArea.style.background = 'linear-gradient(145deg, rgba(82, 183, 136, 0.7), rgba(64, 145, 108, 0.7))';
            });
            
            dropArea.addEventListener('dragleave', function() {
                dropArea.style.borderColor = 'rgba(116, 198, 157, 0.5)';
                dropArea.style.background = 'linear-gradient(145deg, rgba(45, 106, 79, 0.7), rgba(29, 53, 45, 0.7))';
            });
            
            dropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                dropArea.style.borderColor = 'rgba(116, 198, 157, 0.5)';
                dropArea.style.background = 'linear-gradient(145deg, rgba(45, 106, 79, 0.7), rgba(29, 53, 45, 0.7))';
                
                if (e.dataTransfer.files.length) {
                    console.log("拖放文件:", e.dataTransfer.files[0].name);
                    audioUpload.files = e.dataTransfer.files;
                    handleFileSelect({target: audioUpload});
                }
            });
            
            // 点击上传区域
            dropArea.addEventListener('click', function() {
                audioUpload.click();
            });
            
            // 专区切换
            vocalZone.addEventListener('click', function() {
                setZone('vocal');
            });
            
            instrumentalZone.addEventListener('click', function() {
                setZone('instrumental');
            });
            
            // 预设按钮事件
            standardPresetBtn.addEventListener('click', function() {
                setPreset('standard');
            });
            
            enhancedPresetBtn.addEventListener('click', function() {
                setPreset('enhanced');
            });
            
            vocalStandardPresetBtn.addEventListener('click', function() {
                setPreset('standard');
            });
            
            vocalEnhancedPresetBtn.addEventListener('click', function() {
                setPreset('enhanced');
            });
            
            // 按钮事件
            processBtn.addEventListener('click', processAudio);
            downloadBtn.addEventListener('click', downloadAudio);
        }
        
        function setZone(zone) {
            if (currentZone === zone) return;
            
            // 更新当前专区
            currentZone = zone;
            
            // 更新专区卡片状态
            vocalZone.classList.remove('active');
            instrumentalZone.classList.remove('active');
            
            if (zone === 'vocal') {
                vocalZone.classList.add('active');
            } else {
                instrumentalZone.classList.add('active');
            }
            
            // 重置预设为对应专区的默认预设
            setPreset('standard');
            
            showStatus(`已切换到${zone === 'vocal' ? '人声专区' : '纯音乐专区'}`, 'success');
            
            // 如果已有音频，重新处理
            if (audioBuffer) {
                setTimeout(() => {
                    processAudio();
                }, 500);
            }
        }
        
        function setPreset(preset) {
            if (currentPreset === preset) return;
            
            currentPreset = preset;
            
            // 更新按钮状态
            // 根据当前专区更新对应的按钮
            if (currentZone === 'instrumental') {
                standardPresetBtn.classList.remove('active');
                enhancedPresetBtn.classList.remove('active');
                
                if (preset === 'standard') {
                    standardPresetBtn.classList.add('active');
                } else {
                    enhancedPresetBtn.classList.add('active');
                }
            } else {
                vocalStandardPresetBtn.classList.remove('active');
                vocalEnhancedPresetBtn.classList.remove('active');
                
                if (preset === 'standard') {
                    vocalStandardPresetBtn.classList.add('active');
                } else {
                    vocalEnhancedPresetBtn.classList.add('active');
                }
            }
            
            // 更新处理模式显示
            const zoneName = currentZone === 'vocal' ? '人声专区' : '纯音乐专区';
            const presetName = presetConfigs[currentZone][preset].name;
            processingMode.textContent = `${zoneName} - ${presetName}`;
            
            showStatus(`已切换到${presetName}模式`, 'success');
            
            // 如果已有音频，重新处理
            if (audioBuffer) {
                setTimeout(() => {
                    processAudio();
                }, 500);
            }
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                console.log("未选择文件");
                return;
            }
            
            console.log("开始处理文件:", file.name, "类型:", file.type, "大小:", file.size);
            
            // 检查文件类型
            if (!file.type.startsWith('audio/') && !file.name.match(/\.(mp3|wav|ogg|m4a|flac)$/i)) {
                showStatus('请选择音频文件 (MP3, WAV, OGG, M4A, FLAC)', 'error');
                return;
            }
            
            // 显示文件信息
            document.getElementById('fileName').textContent = file.name;
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            document.getElementById('fileSize').textContent = `${fileSizeMB} MB`;
            
            // 创建临时URL用于预览
            const tempUrl = URL.createObjectURL(file);
            originalAudio.src = tempUrl;
            
            // 获取音频时长
            originalAudio.onloadedmetadata = function() {
                const duration = originalAudio.duration;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                document.getElementById('fileDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // 显示音频信息区域
                audioInfo.style.display = 'block';
                processBtn.disabled = false;
                showStatus('音频文件加载成功', 'success');
                
                // 隐藏处理结果区域
                processedAudioSection.style.display = 'none';
                downloadBtn.disabled = true;
            };
            
            originalAudio.onerror = function() {
                showStatus('无法预览此音频文件，但仍可尝试处理', 'error');
                audioInfo.style.display = 'block';
                processBtn.disabled = false;
            };
            
            // 加载音频数据用于处理
            loadAudioForProcessing(file);
        }
        
        function loadAudioForProcessing(file) {
            showStatus('正在解码音频数据...', 'processing');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log("文件读取完成，开始解码音频");
                
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("创建音频上下文，采样率:", audioContext.sampleRate);
                }
                
                audioContext.decodeAudioData(e.target.result, 
                    function(buffer) {
                        console.log("音频解码成功，时长:", buffer.duration, "声道:", buffer.numberOfChannels);
                        audioBuffer = buffer;
                        showStatus('音频解码完成，可以开始处理', 'success');
                    },
                    function(error) {
                        console.error("音频解码失败:", error);
                        showStatus('音频解码失败，请尝试其他文件', 'error');
                        processBtn.disabled = true;
                    }
                );
            };
            
            reader.onerror = function() {
                console.error("文件读取失败");
                showStatus('文件读取失败', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function processAudio() {
            if (!audioBuffer) {
                showStatus('请先加载音频文件', 'error');
                return;
            }
            
            showStatus('正在处理音频... 请稍候', 'processing');
            processBtn.disabled = true;
            downloadBtn.disabled = true;
            
            // 获取当前专区的预设参数
            const preset = presetConfigs[currentZone][currentPreset];
            const speed = preset.speed;
            const pitch = preset.pitch;
            const treble = preset.treble;
            const normalization = preset.normalization || null; // 获取音量标准化参数
            
            console.log(`开始处理，专区: ${currentZone}, 预设: ${currentPreset}, 参数: 速度=${speed}, 音高=${pitch}, 高频削减=${treble}%, 音量标准化=${normalization !== null ? normalization + ' dBFS' : '无'}`);
            
            // 使用setTimeout确保UI更新
            setTimeout(() => {
                try {
                    // 创建新的音频缓冲区
                    const sampleRate = audioBuffer.sampleRate;
                    const numberOfChannels = audioBuffer.numberOfChannels;
                    const length = Math.floor(audioBuffer.length * speed);
                    
                    processedAudioBuffer = audioContext.createBuffer(
                        numberOfChannels, 
                        length, 
                        sampleRate
                    );
                    
                    // 处理每个声道
                    for (let channel = 0; channel < numberOfChannels; channel++) {
                        const inputData = audioBuffer.getChannelData(channel);
                        const outputData = processedAudioBuffer.getChannelData(channel);
                        
                        let maxAmplitude = 0; // 用于音量标准化
                        
                        // 应用速度变化（重采样）
                        for (let i = 0; i < length; i++) {
                            // 计算输入位置
                            const inputIndex = i / speed;
                            
                            // 简单线性插值
                            const indexBefore = Math.floor(inputIndex);
                            const indexAfter = Math.min(Math.ceil(inputIndex), inputData.length - 1);
                            const weight = inputIndex - indexBefore;
                            
                            let sample;
                            if (indexBefore === indexAfter) {
                                sample = inputData[indexBefore];
                            } else {
                                sample = inputData[indexBefore] * (1 - weight) + inputData[indexAfter] * weight;
                            }
                            
                            // 应用音高调整
                            let pitchAdjustedSample = sample;
                            if (pitch !== 0) {
                                const pitchFactor = Math.pow(2, pitch / 12);
                                pitchAdjustedSample = sample * (1 + (pitchFactor - 1) * 0.2);
                            }
                            
                            // 应用高频削减
                            let trebleAdjustedSample = pitchAdjustedSample;
                            if (treble > 0) {
                                const reduction = treble / 100;
                                // 模拟高频削减（简化处理）
                                trebleAdjustedSample = pitchAdjustedSample * (1 - reduction * 0.3);
                                
                                // 如果增强模式，额外应用一些处理
                                if (currentPreset === 'enhanced') {
                                    // 添加轻微的饱和度
                                    trebleAdjustedSample = Math.tanh(trebleAdjustedSample * 1.05) * 0.95;
                                }
                            }
                            
                            // 记录最大振幅用于音量标准化
                            const absValue = Math.abs(trebleAdjustedSample);
                            if (absValue > maxAmplitude) {
                                maxAmplitude = absValue;
                            }
                            
                            outputData[i] = trebleAdjustedSample;
                        }
                        
                        // 应用音量标准化 (0 dBFS)
                        if (normalization !== null) {
                            // 计算增益因子：如果最大振幅为0，则不调整
                            if (maxAmplitude > 0) {
                                // 对于0 dBFS，将最大振幅调整到1.0
                                const gain = 1.0 / maxAmplitude;
                                
                                // 应用增益调整，确保不超过1.0
                                for (let i = 0; i < length; i++) {
                                    outputData[i] = outputData[i] * gain;
                                    
                                    // 确保值在-1到1之间
                                    if (outputData[i] > 1) outputData[i] = 1;
                                    if (outputData[i] < -1) outputData[i] = -1;
                                }
                                
                                console.log(`声道 ${channel} 应用音量标准化，增益因子: ${gain.toFixed(4)}`);
                            }
                        } else {
                            // 如果没有音量标准化，确保值在-1到1之间
                            for (let i = 0; i < length; i++) {
                                if (outputData[i] > 1) outputData[i] = 1;
                                if (outputData[i] < -1) outputData[i] = -1;
                            }
                        }
                    }
                    
                    // 创建处理后的音频URL
                    const processedUrl = createAudioUrlFromBuffer(processedAudioBuffer);
                    processedAudio.src = processedUrl;
                    
                    // 显示处理后的音频
                    processedAudioSection.style.display = 'block';
                    showStatus('音频处理完成！', 'success');
                    processBtn.disabled = false;
                    downloadBtn.disabled = false;
                    
                    // 滚动到处理结果区域
                    processedAudioSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                } catch (error) {
                    console.error('处理过程中出错:', error);
                    showStatus('处理过程中出错: ' + error.message, 'error');
                    processBtn.disabled = false;
                }
            }, 1500);
        }
        
        function createAudioUrlFromBuffer(buffer) {
            // 将AudioBuffer转换为WAV格式
            const wavBuffer = audioBufferToWav(buffer);
            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
            return URL.createObjectURL(blob);
        }
        
        function audioBufferToWav(buffer) {
            const numOfChan = buffer.numberOfChannels;
            const length = buffer.length * numOfChan * 2 + 44;
            const bufferArray = new ArrayBuffer(length);
            const view = new DataView(bufferArray);
            const channels = [];
            let offset = 0;
            let pos = 0;
            
            // 写入WAV头部
            setUint32(0x46464952); // "RIFF"
            setUint32(length - 8); // 文件长度-8
            setUint32(0x45564157); // "WAVE"
            setUint32(0x20746d66); // "fmt "
            setUint32(16); // 子块大小
            setUint16(1); // 音频格式
            setUint16(numOfChan); // 声道数
            setUint32(buffer.sampleRate); // 采样率
            setUint32(buffer.sampleRate * 2 * numOfChan); // 字节率
            setUint16(numOfChan * 2); // 块对齐
            setUint16(16); // 位深度
            setUint32(0x61746164); // "data"
            setUint32(length - pos - 4); // 数据长度
            
            // 写入每个声道的数据
            for (let i = 0; i < numOfChan; i++) {
                channels.push(buffer.getChannelData(i));
            }
            
            while (pos < length) {
                for (let i = 0; i < numOfChan; i++) {
                    let sample = Math.max(-1, Math.min(1, channels[i][offset]));
                    sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(pos, sample, true);
                    pos += 2;
                }
                offset++;
            }
            
            return bufferArray;
            
            function setUint16(data) {
                view.setUint16(pos, data, true);
                pos += 2;
            }
            
            function setUint32(data) {
                view.setUint32(pos, data, true);
                pos += 4;
            }
        }
        
        function downloadAudio() {
            if (!processedAudioBuffer) {
                showStatus('没有可下载的音频', 'error');
                return;
            }
            
            // 生成文件名
            const originalName = audioUpload.files[0].name;
            const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.'));
            const timestamp = new Date().getTime();
            const zoneName = currentZone === 'vocal' ? '人声' : '纯音乐';
            const presetName = currentPreset === 'standard' ? '标准优化' : '增强优化';
            const fileName = `${nameWithoutExt}_山野处理_${zoneName}_${presetName}_${timestamp}.wav`;
            
            // 创建下载链接
            const link = document.createElement('a');
            link.href = processedAudio.src;
            link.download = fileName;
            link.click();
            
            showStatus('音频下载已开始', 'success');
        }
        
        function showStatus(message, type) {
            status.textContent = message;
            status.className = 'status ' + type;
            status.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>